{{/* gotype: entgo.io/ent/entc/gen.Graph */}}

{{ define "client/init" }}
// Client is the client that holds all ent builders.
type Client struct {
	config
	{{- if $.SupportMigrate }}
		// Schema is the client for creating, migrating and dropping schema.
		Schema *migrate.Schema
	{{- end }}
	{{- range $n := $.Nodes }}
		// {{ $n.Name }} is the client for interacting with the {{ $n.Name }} builders.
		{{ $n.Name }} *{{ $n.ClientName }}
	{{- end }}
	{{- template "client/fields/additional" $ }}
	{{- with $tmpls := matchTemplate "client/fields/additional/*" }}
		{{- range $tmpl := $tmpls }}
			{{- xtemplate $tmpl $ }}
		{{- end }}
	{{- end }}
	// authzActivated determines if the authz hooks have already been activated
	authzActivated bool
}

// NewClient creates a new client configured with the given options.
func NewClient(opts ...Option) *Client {
	cfg := config{log: log.Println, hooks: &hooks{}, inters: &inters{}}
	cfg.options(opts...)
	client := &Client{config: cfg}
	client.init()
	return client
}

func (c *Client) init() {
	{{- if $.SupportMigrate }}
		c.Schema = migrate.NewSchema(c.driver)
	{{- end }}
	{{- range $n := $.Nodes }}
		c.{{ $n.Name }} = New{{ $n.ClientName }}(c.config)
	{{- end }}
}

// WithAuthz adds the authz hooks to the appropriate schemas - generated by entfga
func (c *Client) WithAuthz() {
	if !c.authzActivated {
	{{- range $n := $.Nodes }}
		{{- $name := $n.Name }}
		{{ if $n.Annotations.Authz }}
			{{ $includeHooks := extractIncludeHooks $n.Annotations.Authz.IncludeHooks }}
			{{ if $includeHooks}}
	for _, hook := range entfga.AuthzHooks[*{{ $name }}Mutation]() {
		c.{{ $name }}.Use(hook)
	}
			{{- end }}
		{{- end }}
	{{- end }}
		c.authzActivated = true
	}
}

{{ end }}