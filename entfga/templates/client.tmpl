{{/* gotype: entgo.io/ent/entc/gen.Graph */}}

{{- define "import/additional/entfga" }}
	"github.com/theopenlane/iam/entfga"
{{- end }}

{{ define "client/fields/additional/authz" }}
	// authzActivated determines if the authz hooks have already been activated
	authzActivated bool
{{ end }}

{{ define "client/additional/authz" }}
// WithAuthz adds the authz hooks to the appropriate schemas - generated by entfga
func (c *Client) WithAuthz() {
	if !c.authzActivated {
	{{- range $n := $.Nodes }}
		{{- $name := $n.Name }}
		{{ if $n.Annotations.Authz }}
			{{ $includeHooks := extractIncludeHooks $n.Annotations.Authz.IncludeHooks }}
			{{ if $includeHooks}}
	for _, hook := range entfga.AuthzHooks[*{{ $name }}Mutation]() {
		c.{{ $name }}.Use(hook)
	}
			{{- end }}
		{{- end }}
	{{- end }}
		c.authzActivated = true
	}
}
{{ end }}